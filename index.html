<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Tomato Cam</title>
		<meta name="author" content="gelx">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta name="theme-color" content="rgb(51, 51, 51)">

		<script type="text/javascript" src="https://ge-lx.github.io/bunch/bunch.js"></script>
		<script type="text/javascript" src="https://ge-lx.github.io/bunch/bnc.js"></script>
		<script type="text/javascript">
			(function ({ define, resolve, Observable, ComputedObservable }) {
				const sendFetch = async (method = 'GET', url, body) => {
					const request = {
						method,
						mode: 'cors',
						cache: 'no-cache',
						redirect: 'follow',
						referrerPolicy: 'origin'
					};

					if (typeof body === 'object') {
						request.headers = { 'Content-Type': 'application/json' };
						request.body = JSON.stringify(body)
					}

					
					let response;
					try {
						response = await fetch(url, request);
					} catch (error) {
						throw new Error(error.message, url, request);
					}
					const data = await response.json();
					if (response.ok) {
						return data;
					} else {
						throw new Error(response.status, data.error, url, request);
					}
				};

				define('bind', () => {
					return (scope, element, obj) => {
						const results = {};
						for (let attributeName of obj) {
							const expression = element.getAttribute(attributeName);
							if (attributeName.endsWith('$')) {
								results[attributeName] = scope.$get$(expression);
							} else {
								results[attributeName] = scope.$get(expression);
							}
						}
						return results;
					};
				});

				define('day', [{ noCache: true }, (bind) => {
					return {
						$template: `
							<div class="day">
								<h3 bnc-bind="day.date"></h3>
								<a bnc-if="day.hasVideo" bnc-attr="href: link">view video</a>
								<p class="images" bnc-bind="day.numOfImages"></p>
							</div>
						`,
						$link: (scope, element) => {
							const { day } = bind(scope, element, ['day']);
							const link = `${window.location.origin}/data/${day.date}/output.mp4`
							scope.$assign({ day, link });
						}
					};
				}]);

				define('info', [{ noCache: true }, (bind) => {
					return {
						$template: `
							<div class="info">
								<div>
									<h1>Last image taken at</h1>
									<h2 bnc-bind="lastImageTime$"></h2>
								</div>
								<pre class="settings" bnc-bind="settings$"></pre>
							</div>
						`,
						$link: (scope, element) => {
							const { info$ } = bind(scope, element, ['info$']);
							const lastImageTime$ = ComputedObservable(info$, info => {
								return (new Date(info.lastImageTimestamp * 1000)).toLocaleTimeString();
							});
							const settings$ = ComputedObservable(info$, info => JSON.stringify(info.settings));

							scope.$onDestroy(() => {
								lastImageTime$.destory();
								settings$.destory();
							});
							scope.$assign({ lastImageTime$, settings$ });
						}
					};
				}]);

				define('resources', () => {
					const resources = {};

					const resource = (url, defaultValue) => {
						const obs$ = Observable(defaultValue);

						const update = async () => {
							obs$.value = await sendFetch('GET', url);
						};

						setInterval(update, 10 * 1000);
						update();
						return obs$;
					};

					return {
						currentInfo$: resource(`${window.location.origin}/info`, {}),
						currentDays$: resource(`${window.location.origin}/days`, [])
					};
				});

			}(bnc_bunch));		
		</script>
		<style type="text/css">
			* {
				box-sizing: border-box;
			}

			bnc-root {
				display: flex;
				width: fit-content;
				max-width: 100%;
				margin: auto;
			}

			bnc-module {
				display: block;
			}

			.day {
				display: flex;
				flex-flow: row nowrap;
				align-items: center;
				justify-content: space-between;

				padding: 10px;
				border: 1px dashed rgba(0, 0, 0, 0.12);
				border-radius: 5px;

				margin: 5px;
			}

			.day h3 {
				margin: 10px;
			}

			.info {
				display: inline-flex;
				flex-flow: column nowrap;

				margin: 5px;
				padding: 10px;
				border: 3px dashed #3288bd;
				border-radius: 5px;
			}

			.info > div:first-of-type {
				display: flex;
				flex-flow: row nowrap;
				justify-content: space-between;
				align-items: center;
			}
			
		</style>
	</head>
	<body>
		<bnc-root>
			<bnc-module name="resources">
				<bnc-element name="info" info$="currentInfo$"></bnc-element>

				<div class="days_holder">
					<div bnc-for="day in currentDays$">
						<div>
							<bnc-element name="day" day="day"></bnc-element>
						</div>
					</div>
				</div>
			</bnc-module>
		</bnc-root>
	</body>
</html>